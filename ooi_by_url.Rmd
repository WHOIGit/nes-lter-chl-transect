---
title: "OOI Join by URL"
author: "Kate Morkeski"
date: "3/12/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse) #need tidyverse for %>% apparently
library(httr)
library(readxl)
```
Accessing OOI data from Alfresco
```{r}

url <- ('https://alfresco.oceanobservatories.org/alfresco/webdav/OOI/Coastal%20Pioneer%20Array/Cruise%20Data/Pioneer-09_AR24_2017-10-22/Ship%20Data/Water%20Sampling/Pioneer-09_AR24_Chlorophyll_Sample_Data_2020-03-27_ver_1-00.xlsx')
```

```{r}

httr::GET(url, authenticate("guest", "guest"), write_disk(tf <- tempfile(fileext = ".xlsx")))
tf
```
Reading in Excel file from Alfresco and formatting cruise ID and column headers
```{r}

ar24ooi <- read_excel(tf, 1L) 

ar24ooi$Cruise <- gsub("-", "", ar24ooi$Cruise)

ar24ooi <- ar24ooi %>% 
  rename (cruise = Cruise, 
          date = Date,
          cast = Cast, 
          niskin = Niskin, 
          replicate = Replicate,
          depth_rep = "Water Depth Rep",    #renamed variable without space
          filter_id_ooi = "Filter Sample",   #renamed variable without space
          chl = "Chl ug_per_L" ,     #renamed variable without space
          phaeo = "Phaeo ug_per_L"  #renamed variable without space
          ) %>%
  
  mutate(chl_ooi = round(chl, 3)) %>%
  mutate(phaeo_ooi = round(phaeo, 3)) %>%

  select(-"Station Depth", 
         -"Trip Depth", 
         -"Brown Bottle", 
         -"Vol Filt", 
         -"Filter Size", 
         -"Vol Extracted", 
         -Sample, 
         -"90% Acetone", 
         -"Dilution During Reading", 
         -"Chl_Cal_Filename", 
         -"tau_Calibration", 
         -"Fd_Calibration", 
         -Rb, 
         -Ra, 
         -blank, 
         -Rb_blank, 
         -Ra_blank, 
         -"Lab Notebook number and page", 
         -Cal_Date, 
         -Fluorometer
         )

```
Read in cruise data from API and join to Alfresco data in order to obtain OOI sample identifier for the subset of samples belonging to OOI. Change this to read in three legs from API. Then join once with Alfresco. (One call to read from api, one call to full join)
```{r}
ar24a <- read_csv("https://nes-lter-data.whoi.edu/api/chl/ar24a.csv")
ar24b <- read_csv("https://nes-lter-data.whoi.edu/api/chl/ar24b.csv")
ar24c <- read_csv("https://nes-lter-data.whoi.edu/api/chl/ar24c.csv")

ar24abc <- rbind(ar24a, ar24b, ar24c)

ar24abc <- ar24abc %>% 
  mutate(chl_r = round(chl, 3)) %>% 
  mutate(phaeo_r = round(phaeo, 3)) %>% 
  select(-filter_size, -tau_calibration, -fd_calibration, -rb, -ra, -blank, -rb_blank, -ra_blank, -chl, -phaeo)

ar24all <- full_join(ar24ooi, ar24abc, by = c('cruise','cast','niskin','replicate'))

ar24all <- ar24all %>% mutate(chl_diff = chl_ooi - chl_r)

write.csv(ar24all, 'ar24all.csv')

filter(ar24all, chl_diff > 0 | chl_diff < 0)

```

Read in csv file of concatenated cruises (ie transect data)
Will need to join with AR24 data

```{r}
#api_chl <- read_csv("chl-transect-api.csv")
```